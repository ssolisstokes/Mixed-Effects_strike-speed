---
title: "Mixed Effects Model Selection: *Crotalus* Strike Speed"
author: "Sienna Solis-Stokes"
output:
  html_document:
    toc: true
    toc_float: true
    theme:
      success: "#d9534f"
      base_font: 
        google: "Lora"
      heading_font: 
        google: "Lora"
      bootswatch: sandstone
      bslib: true
---
<style type="text/css">

body{ /* Normal  */
      font-size: 16px;
      text-align: justified;
}
.author {
  font-size: 14px;
  color: #8e8c84;
  text-align: center;
}
h1.title { /* Title*/
  font-size: 32px;
  color: Black;
  text-align: center;
}
h1 { /* Header 1 */
  font-size: 28px;
  color: Black;
  font-weight: bold;
}
p.caption{
  font: Lora;
  font-size: 14px;
}
</style>

```{r setup, include=FALSE}
#knitr::opts_chunk$set(echo = TRUE)

# load in libraries
library(ggplot2)
library(dplyr)
library(arm)
library(ggfortify)
library(lme4)
library(emmeans)
library(ggtext)
library(patchwork)
library(performance)
library(flexplot)
library(ggthemes)
library(lmerTest)

# load in the dataset
strikes <- read.csv("strike_data.csv")

# make snake (ID) and treatment temperature factors
strikes$snake <- as.factor(strikes$snake)
strikes$temp_treatment <- as.factor(strikes$temp_treatment)
```
# Introduction

This data set was sourced using [Dryad](https://datadryad.org/) from [Whitford et al. 2020](https://journals.biologists.com/jeb/article/223/14/jeb223859/224523/The-effects-of-temperature-on-the-defensive): "The effects of temperature on the defensive strikes of rattlesnakes". Whitford et al. conducted repeated laboratory trials to determine how temperature may influence the ability of rattlesnakes to defend themselves against predators. The trials were completed using 24 snakes; 12 western rattlesnakes (*Crotalus oreganus helleri*) and 12 mojave rattlesnakes (*Crotalus scutulatus*). Each snake was tested up to 3 times in each temperature treatment: 15°C, 20°C, 25°C, 30°C, and 35°C. During a trial each snake was presented with a balloon attached to snake hook and reactions were recorded using high speed cameras.

<iframe width="800" height="400" src="https://movie.biologists.com/video/10.1242/jeb.223859/video-2" data-external="1">

</iframe>

# Plots

```{r unbalanced data; raw data, echo=FALSE, message=FALSE, warning=FALSE}
# plot the changes across temperature treatments for each snake
plot_treat.bar <- ggplot(strikes, aes(temp_treatment, fill=snake)) +
  geom_bar(color="black") +
  scale_y_continuous(breaks=seq(10, 25, 35)) +
  ggtitle(label = "Unbalanced Sampling Plot",
          subtitle = "n = 23 snakes; 5 temp. treatments; 295 total tests") +
  theme_calc()

# box plot of raw data by temperature treatment; does not adjust for repeated measures of snakes
plot_treat.box <- ggplot(strikes, aes(x=temp_treatment, y=neck_max_vel, group = temp_treatment, color=temp_treatment)) + 
  geom_boxplot() +
  scale_y_continuous() +
  labs(title="Uneven Sampling: Tests",
       subtitle = "Raw data",
       x= "Temperature Treatment(°C)", 
       y = "Maximum Velocity of Strike (m/s)")+
  theme_calc() +
  theme(legend.position = "none")

#box plot of raw data by snake
plot_snake.box <- ggplot(strikes, aes(x=snake, y=neck_max_vel, group = snake, color=snake)) + 
  geom_boxplot() +
  scale_y_continuous() +
  labs(title="Uneven Sampling: Snakes",
       subtitle = "Raw data",
       x= "Snake", 
       y = "Maximum Velocity of Strike (m/s)")+
  theme_calc() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position = "none")

plot_treat.bar
plot_treat.box + plot_snake.box

```

```{r linear plot, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(strikes, aes(x=temp_treatment, y=neck_max_vel, group=snake, color=snake, shape=snake)) + 
  geom_point(size=4, position = position_dodge2(width=.33, preserve = "total")) +
  scale_y_continuous() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title="Hotter = Faster?",
       x= "Temperature Treatment (°C)", 
       y = "Maximum Velocity of Strike (m/s)") +
  theme_calc() +
  theme(legend.position = "none")

```

To clean the data for this practice I removed one snake from the data which did not complete trials in all temperatures and replaced NA's with 0's in columns where no strike occurred. 

```{r replace NAs, message=FALSE, warning=FALSE, include=FALSE}
# Replace NA with 0 in all numeric columns
strikes_clean <- replace(strikes, is.na(strikes), 0)
```

I used this data to run a mixed model which accounted for the repeated measures of snakes and the random effect variation between snakes to analyse the fixed effect: temperature treatment.

```{r first mixed model for treatment temps, message=FALSE, warning=FALSE}

mixed_treatment <- lmer(neck_max_vel ~ temp_treatment * snake + (1|snake), data = strikes_clean)
anova(mixed_treatment)
```

```{r performance test, fig.width = 8, fig.height = 10, message=FALSE, warning=FALSE}
# check the model
performance::check_model(mixed_treatment)
```

To account for the unbalanced data (each snake not completing each temperature trial an equal amount of times), I used the estimated marginal means to plot the mean maximum strike velocity of each temperature treatment.

The gray points represent the raw data means.
```{r emmeans, echo=FALSE, message=FALSE, warning=FALSE}
mixed_treatment_emm <- emmeans(mixed_treatment, "temp_treatment")
data_emm <- as.data.frame(mixed_treatment_emm)

treatment_means <- strikes %>%
  group_by(temp_treatment) %>%
  filter(!is.na(neck_max_vel)) %>%
  summarise(mean_spd = mean(neck_max_vel),
            se_rating=sd(neck_max_vel)/sqrt(n()))

plot_strike.means <-
  ggplot(data_emm, aes(x=temp_treatment, y=emmean)) + 
  geom_point(size=4) +
  scale_y_continuous(limits = c(2, 3.8)) +
  geom_errorbar(aes(ymin=emmean-SE, ymax=emmean+SE), width=.2) +
  labs(title="Hotter = Faster? Rattlesnake Strike Speeds", x= "Temperature Treatment (C)", y = "Max Strike Velocity (m/s)") +
  geom_point(data = treatment_means, size = 4, x= treatment_means$temp_treatment, y = treatment_means$mean_spd, color = "gray") +
  theme_calc() +
  theme(legend.position = "none")

plot_strike.means

```

I also wanted to look at the variation between snakes nested within species.

```{r mixed effects: species plot, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(strikes, aes(x=temp_treatment, y=neck_max_vel, group=species, color=species, shape=species)) + 
  geom_point(size=4, position = position_dodge2(width = 0.5, preserve = "total")) +
  scale_y_continuous() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title="C.o. helleri vs C. scutulatus",
       subtitle = "n = 23, helleri = 12, scutulatus = 11",
       x= "Temperature Treatment (°C)", 
       y = "Maximum Velocity of Strike (m/s)") +
  theme_calc()
```

```{r fit mixed models, message=FALSE, warning=FALSE}
mixed_treatment.spp1 <- lmer(neck_max_vel ~ temp_treatment + (1|snake), data = strikes_clean) # same slopes; random intercepts
mixed_treatment.spp2 <- lmer(neck_max_vel ~ temp_treatment + (species|snake), data = strikes_clean) # random intercepts; random slopes
```

Visualize the data using flexpot:
```{r flexplot model 1, echo=FALSE, message=FALSE, warning=FALSE}
flexplot::visualize(mixed_treatment.spp1, plot="model", sample=23) +  
  scale_x_discrete(limits = c("15", "20", "25", "30", "35")) +        
  ggtitle("random intercepts-same slopes") +
  labs(subtitle = "Formula: Max Velocity ~ Temperature Treatment + (1|Snake)")
```

```{r flexplot model 2, echo=FALSE, message=FALSE, warning=FALSE}
flexplot::visualize(mixed_treatment.spp2, plot="model", sample=23) +
  scale_x_discrete(limits = c("15", "20", "25", "30", "35")) +       
  ggtitle("random intercepts-random slopes") +
  labs(subtitle = "Formula: Max Velocity ~ Temperature Treatment + (Species | Snake)")

```

Similar to our example in class, the fixed effect (black line) is the same between the models, but the random effect (snake/snake nested in species) is different.

Next I used the *arm* package to compare intercepts and slopes of the models.
```{r coef model 1}
arm::display(mixed_treatment.spp1)
```

```{r coef model 2}
arm::display(mixed_treatment.spp2)
```

The model summaries show identical slopes.

Next I used the **parameters* package to compare coefficients.

```{r parameters, echo=FALSE, message=FALSE, warning=FALSE}
result <- parameters::compare_parameters(mixed_treatment.spp1, mixed_treatment.spp2, select = "{estimate}<br>({se})|{p}")
print_html(result)
```


Now to compare the models to see which model best explains the results. 

```{r performance, echo=FALSE, message=FALSE, warning=FALSE}
performance::compare_performance(mixed_treatment.spp1, mixed_treatment.spp2)
```

# Model Interpretation
Both models were statistically significant in their fixed effect of temperature treatment for all treatments except 20, and this was primarily what we were interested in. Model 2 (lmer(neck_max_vel ~ temp_treatment + (species|snake), data = strikes_clean)) has a lower AIC and a 99% chance of best describing the data. This model removed the random effect of the snake completing the trial nested within the different species, fitting a different slope and intercept for each individual. These results align with the results of Whitford et al. which stated that their results showed an overall faster strike speed as temperature increased for all snakes, the mojave rattlesnakes struck less times overall (125) than the western rattlesnakes (179).
